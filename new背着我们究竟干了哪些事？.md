## new背着我们究竟干了哪些事？

Java是一门面向对象的编程语言，在Java程序运行的过程中，无时无刻都有对象被创建出来。创建对象通常由以下几种方式：

* 使用new关键字

* 反序列化

* 克隆

* 反射

  

当虚拟机遇到一个new指令的时候，它会进行哪些操作呢？

* 首先去检查new的参数是否能够在常量池中定位到一个类的符号引用，并且检查这个符号引用代表的类是否已经被加载、连接、初始化过。如果没有，则需要先执行类加载过程。

* 在类加载检查通过后，接下来虚拟机将为新生的对象分配内存。对象所需要内存的大小在类加载完成后便可完全确定。

  为对象分配内存等同于把一块确定大小的内存从Java堆中划分出来。如果Java堆内存是绝对规整的，所有用过的内存都放在一边，空闲的内存放在另外一边，中间放着一个指针作为分界点的指示器，为对象分配内存只需要把指针向空闲空间那边移动一段和对象大小相等的距离，这种分配方式叫做“指针碰撞”。如果Java堆内存不是规整的，那么虚拟机就必须维护一个空闲链表，记录哪些内存还没被分配出去。

  Java堆是线程共享的，对象创建在虚拟机中是非常频繁的，在并发情况下，为对象分配内存不是线程安全的，解决方案有两种，一是对分配内存空间的动作进行同步处理；二是把内存分配的动作按照线程划分在不同的空间之中进行，即每个线程在Java堆中预先分配一小块内存，称为本地线程分配缓冲（Thread Local Allocation Buffer, TLAB）。哪个线程需要分配内存，就在哪个线程的TLAB上分配，只有在TLAB用完并分配新的TLAB时，才需要同步锁定。虚拟机是否使用TLAB，可以通过-XX:+/-UseTLAB参数来设定。

* 内存分配完成之后，虚拟机需要将分配到的内存空间都初始化为零。同时，要对对象进行必要的设置，例如这个对象属于哪个类的实例，如何才能找到类的元数据信息，对象的哈希码，对象的GC分代年龄等信息，这些信息存放到对象的对象头（Object Header）之中。

* 上述操作都进行完之后，此时需要执行初始化操作，要执行初始化代码块、构造方法等。



